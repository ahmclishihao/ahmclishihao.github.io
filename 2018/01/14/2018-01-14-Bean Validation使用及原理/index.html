<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 2018-01-14 Bean Validation使用及原理 · 潜水的沙 -- Java 开发者</title><meta name="description" content="2018-01-14 Bean Validation使用及原理 - 潜水的沙"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://lshao.xyz/atom.xml" title="潜水的沙 -- Java 开发者"></head><body><div class="wrap"><header><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">潜水的沙</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/ahmclishihao" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://blog.csdn.net/ahmclishihao" target="_blank" class="nav-list-link">CSDN</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">2018-01-14 Bean Validation使用及原理</h1><div class="post-info">2018年1月14日</div><div class="post-content"><a id="more"></a>
<h2 id="一、讨论的主题"><a href="#一、讨论的主题" class="headerlink" title="一、讨论的主题"></a>一、讨论的主题</h2><p>本次分享讨论的主题是，如何规范的进行参数校验与Bean validation的使用。</p>
<h2 id="二、服务器端参数校验的重要性："><a href="#二、服务器端参数校验的重要性：" class="headerlink" title="二、服务器端参数校验的重要性："></a>二、服务器端参数校验的重要性：</h2><p>几乎所有的应用程序都需要对用户的输入进行参数校验，这包括客户端里用户可见的输入校验，以及服务器端的java bean校验两种校验，通常为了保证校验的准确性、安全性，参数校验相对依赖服务器端的校验过程。因此服务器端的参数校验往往是整个应用安全性最重要的一道防线。</p>
<h2 id="三、如何进行参数校验？"><a href="#三、如何进行参数校验？" class="headerlink" title="三、如何进行参数校验？"></a>三、如何进行参数校验？</h2><h4 id="传统的参数校验"><a href="#传统的参数校验" class="headerlink" title="传统的参数校验"></a>传统的参数校验</h4><p>传统的参数校验采用会采用原始的条件语句来拦截参数，并使用多层嵌套的判断逻辑来进行校验，直到所有的判断条件达成才进入真正的业务逻辑。</p>
<p>两个传统校验例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 例1：新增管理员</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReturnBean <span class="title">addAdmin</span><span class="params">(Admin user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(user.getAdmName())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReturnBean(ReturnBean.ERROR, <span class="string">"用户名不能为空"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(user.getAdmPassword())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReturnBean(ReturnBean.ERROR, <span class="string">"密码不能为空"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == user.getType() || <span class="number">0</span> == user.getType()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReturnBean(ReturnBean.ERROR, <span class="string">"管理员类型不能为空"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(user.getMobile())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReturnBean(ReturnBean.ERROR, <span class="string">"手机号不能为空"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 例2：更新商户费率</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String currentUserName = SuperAdminCommonUtil.getCurrentUserName(request);</span><br><span class="line"><span class="comment">// 验证存在当前登录用户</span></span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(currentUserName)) &#123;</span><br><span class="line">    ExSuperAdmin modifyAdmin = mAdminService.getAdminByLoginName(currentUserName);</span><br><span class="line">    <span class="keyword">if</span> (modifyAdmin != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 更新指定城市的费率</span></span><br><span class="line">        <span class="keyword">boolean</span> update = exSellerFeeTranService.saveOrUpdateSellerFeeRate(sellerFee, type,modifyAdmin);</span><br><span class="line">        <span class="keyword">return</span> update ? <span class="keyword">new</span> ReturnBean(ReturnBean.SUCCESS,<span class="string">"数据更新成功!"</span>) : newReturnBean(ReturnBean.ERROR,<span class="string">"数据更新失败!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ReturnBean(ReturnBean.ERROR_NOT_LOGIN, <span class="string">"当前用户数据异常!"</span>);</span><br></pre></td></tr></table></figure>
<p>特点：</p>
<ul>
<li>简单一般由if/else等语句嵌套组成</li>
<li>但无法满足简单便捷的错误信息管理</li>
<li>逻辑复杂时讲造成大量缩进，使代码格式混乱，不易阅读和复查</li>
<li>验证过程与业务逻辑耦合度太高，不利于业务新增与修改</li>
</ul>
<h4 id="断言式的参数校验"><a href="#断言式的参数校验" class="headerlink" title="断言式的参数校验"></a>断言式的参数校验</h4><p>在最近的项目中，我们使用了<code>ValidateUtil</code>来进行参数校验，通过Spring Boot全局管理异常的方式,来指定<code>ValidationException</code>进行错误抛出和错误信息的提示。</p>
<p>如下是一段使用样例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 例：添加员工</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">addUser</span><span class="params">(@CurrentUser CustomerUserDetails currentUser,</span></span></span><br><span class="line"><span class="function"><span class="params">                      User user,</span></span></span><br><span class="line"><span class="function"><span class="params">                      @RequestParam(<span class="string">"password2"</span>)</span> String pwd2) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验参数</span></span><br><span class="line">    String username = user.getUsername();</span><br><span class="line">    String password = user.getPassword();</span><br><span class="line">    String password2 = pwd2;</span><br><span class="line">    ...</span><br><span class="line">    ValidateUtil.check(StringUtils.isNotBlank(username), <span class="string">"登录账号不能为空"</span>);</span><br><span class="line">    ValidateUtil.check(CheckUtil.checkUsername(username), <span class="string">"登录账号格式错误"</span>);</span><br><span class="line"></span><br><span class="line">    ValidateUtil.check(StringUtils.isNotBlank(password), <span class="string">"登录密码不能为空"</span>);</span><br><span class="line">    ValidateUtil.check(CheckUtil.checkPassword(password), <span class="string">"密码格式错误"</span>);</span><br><span class="line"></span><br><span class="line">    ValidateUtil.check(StringUtils.isNotBlank(password2), <span class="string">"确认密码不能为空"</span>);</span><br><span class="line">    ValidateUtil.check(password.equals(password2), <span class="string">"两次密码不同"</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 校验登录账号是否重复</span></span><br><span class="line">    <span class="keyword">long</span> countByUserName = userService.countByUserName(username.trim());</span><br><span class="line">    ValidateUtil.check(countByUserName == <span class="number">0</span>, <span class="string">"登录账号已存在"</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 添加用户</span></span><br><span class="line">    <span class="keyword">boolean</span> insertResult = userService.insert(user).getId() &gt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (insertResult) &#123;</span><br><span class="line">            <span class="keyword">return</span> ErrorInfo.ok(<span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ErrorInfo.ok(<span class="keyword">false</span>).message(<span class="string">"添加失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>错误返回时的样例：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>:<span class="string">"101"</span>,</span><br><span class="line">    <span class="attr">"message"</span>:<span class="string">"登录账号不能为空"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>前端通过<code>code = “101”</code>获知参数校验失败。</p>
<p>特点：</p>
<ul>
<li>解决了一定程度的if/else逻辑嵌套，让逻辑更清晰</li>
<li>代码的可读性有一定的提升</li>
<li>使用了全局异常捕捉，方便统一收集和处理错误信息</li>
</ul>
<p>但随着业务的增加，缺点也随之出现：</p>
<ul>
<li>代码有一定的书写成本，一条验证很长，没有语义化不利于后期阅读</li>
<li>仍然与业务逻辑相互嵌套，使得代码拓展性没有的到提升</li>
<li>不能应对不同需求的变更，当有验证逻辑变动时，代码面临重写的危险</li>
<li>验证信息只能单条返回，不能满足多条返回的验证情景，不利于错误提示</li>
</ul>
<h3 id="Bean-Validation参数校验"><a href="#Bean-Validation参数校验" class="headerlink" title="Bean Validation参数校验"></a>Bean Validation参数校验</h3><p>为了应对开发人员日常的参数校验需求，<a href="https://baike.baidu.com/item/Java%20Community%20Process/19279280?fr=aladdin" target="_blank" rel="noopener">JCP组织</a> 先后通过了<a href="https://jcp.org/en/jsr/detail?id=303" target="_blank" rel="noopener">JSR-303</a>、<a href="https://jcp.org/en/jsr/detail?id=349" target="_blank" rel="noopener">JSR-349</a>、<a href="https://www.jcp.org/en/jsr/detail?id=380" target="_blank" rel="noopener">JSR-380</a>既Bean Validation规范，使用注解的方式对Java Bean 进行约束验证。<br>Hibernate Validation便是该规范的一种实现，Spring中二次封装了Hibernate Validation使Bean Validation规范在Spring 应用程序中更简单更快捷的被使用。</p>
<h4 id="Bean-Validation"><a href="#Bean-Validation" class="headerlink" title="Bean Validation"></a>Bean Validation</h4><p>Bean Validation 特性：</p>
<blockquote>
<p>bean validation 2.0（摘自<a href="http://beanvalidation.org/2.0/" target="_blank" rel="noopener">官网介绍</a>）</p>
<ul>
<li>支持通过注解参数化类型的类型参数来验证容器元素，例如List&lt;@Positive Integer&gt; positiveNumbers。这还包括：<ul>
<li>容器类型的更灵活的级联验证</li>
<li>支持 java.util.Optional</li>
<li>支持JavaFX声明的属性类型</li>
<li>支持自定义容器类型</li>
</ul>
</li>
<li>为新的日期/时间数据类型的支持（JSR 310）@Past和@Future</li>
<li>新的内置限制：@Email，@NotEmpty，@NotBlank，@Positive， @PositiveOrZero，@Negative，@NegativeOrZero，@PastOrPresent和 @FutureOrPresent</li>
<li>利用JDK 8的新功能（内置约束标记为可重复，参数名称通过反射来检索）</li>
</ul>
<p>bean validation 1.1(本次使用)</p>
<ul>
<li>依赖注入与CDI更好的集成支持</li>
<li>对方法和构造验证支持</li>
<li>级联当用于组转换支持</li>
<li>用于基于EL消息插值支持 例如：${validatedValue}</li>
</ul>
</blockquote>
<p>Hibernate Validation支持第二中spi加载</p>
<ol>
<li>最简单的使用方式（spi加载）<br>spi是java api提供一种加载服务的方式，<a href="http://blog.csdn.net/fenglibing/article/details/7083071" target="_blank" rel="noopener">查看更多关于spi</a></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ValidatorFactory factory = Validation.buildDefaultValidatorFactory();</span><br></pre></td></tr></table></figure>
<ol>
<li><p>其次Bean Validation支持XML加载<br>在XML中定义的ValidationProviderResolver进行加载和解析(因使用场景逐渐变少，因此此处不讨论xml配置)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Configuration&lt;?&gt; configuration = Validation</span><br><span class="line">   .byDefaultProvider()</span><br><span class="line">   .providerResolver( <span class="keyword">new</span> HibernateValidator() )</span><br><span class="line">   .configure();</span><br><span class="line">ValidatorFactory factory = configuration.buildValidatorFactory();</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过自定义的ValidationProviderResolver加载ValidatorFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ACMEConfiguration configuration = Validation</span><br><span class="line">   .byProvider(ACMEProvider.class)</span><br><span class="line">   .providerResolver( <span class="keyword">new</span> MyResolverStrategy() )</span><br><span class="line">   .configure();</span><br><span class="line">ValidatorFactory factory = configuration.buildValidatorFactory();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="Hibenate-Validation验证"><a href="#Hibenate-Validation验证" class="headerlink" title="Hibenate Validation验证"></a>Hibenate Validation验证</h4><p>Hibernate Validation支持SPI启动方式，在其jar中已经放置描述文件 <code>/META-INF/services/javax.validation.spi.ValidationProvider</code></p>
<p><code>Validation</code>结合<code>HibernateValidator</code>查看Hibernate的验证原理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Validation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1.默认的快捷工厂</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ValidatorFactory <span class="title">buildDefaultValidatorFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> byDefaultProvider().configure().buildValidatorFactory();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2.默认的启动器</span></span><br><span class="line"><span class="comment">     * 启动器内存储了使用到的 ValidationProviderResolver</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GenericBootstrap <span class="title">byDefaultProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> GenericBootstrapImpl();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3.获取配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Configuration&lt;?&gt; configure() &#123;</span><br><span class="line">        <span class="comment">// ValidationProvider解析器，用于加载当前classpath路径中存在的 ValidationProvider</span></span><br><span class="line">        ValidationProviderResolver resolver = <span class="keyword">this</span>.resolver == <span class="keyword">null</span> ?getDefaultValidationProviderResolver() : <span class="keyword">this</span>.resolver;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 生成配置，同时该解析器被注入到启动器中</span></span><br><span class="line">        Configuration&lt;?&gt; config;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            config = resolver.getValidationProviders().get( <span class="number">0</span> ).createGenericConfiguration( <span class="keyword">this</span> );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( RuntimeException re ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException( <span class="string">"Unable to instantiate Configuration."</span>, re );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4.SPI加载过程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GetValidationProviderListAction</span> <span class="keyword">implements</span> <span class="title">PrivilegedAction</span>&lt;<span class="title">List</span>&lt;<span class="title">ValidationProvider</span>&lt;?&gt;&gt;&gt; </span>&#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> List&lt;ValidationProvider&lt;?&gt;&gt; loadProviders(ClassLoader classloader) &#123;</span><br><span class="line">			ServiceLoader&lt;ValidationProvider&gt; loader = ServiceLoader.load( ValidationProvider.class, classloader );</span><br><span class="line">			Iterator&lt;ValidationProvider&gt; providerIterator = loader.iterator();</span><br><span class="line">			List&lt;ValidationProvider&lt;?&gt;&gt; validationProviderList = <span class="keyword">new</span> ArrayList&lt;ValidationProvider&lt;?&gt;&gt;();</span><br><span class="line">			<span class="keyword">while</span> ( providerIterator.hasNext() ) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					validationProviderList.add( providerIterator.next() );</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> ( ServiceConfigurationError e ) &#123;</span><br><span class="line">					<span class="comment">// ignore, because it can happen when multiple</span></span><br><span class="line">					<span class="comment">// providers are present and some of them are not class loader</span></span><br><span class="line">					<span class="comment">// compatible with our API.</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> validationProviderList;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="HibernateValidator的作用"><a href="#HibernateValidator的作用" class="headerlink" title="HibernateValidator的作用"></a>HibernateValidator的作用</h5><p>HibernateValidator为ValidationProvider的实现类，起作用便是生成<code>ConfigurationImpl</code>和<code>ValidatorFactoryImpl</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ValidationProvider</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Configuration</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	Configuration&lt;?&gt; createGenericConfiguration(BootstrapState state);</span><br><span class="line"></span><br><span class="line">	<span class="function">ValidatorFactory <span class="title">buildValidatorFactory</span><span class="params">(ConfigurationState configurationState)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过SPI获取到Hibernate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HibernateValidator</span> <span class="keyword">implements</span> <span class="title">ValidationProvider</span>&lt;<span class="title">HibernateValidatorConfiguration</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成配置器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Configuration&lt;?&gt; createGenericConfiguration(BootstrapState state) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ConfigurationImpl( state );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成ValidatorFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ValidatorFactory <span class="title">buildValidatorFactory</span><span class="params">(ConfigurationState configurationState)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ValidatorFactoryImpl( configurationState );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合下图讲解<code>ValidatorFactory</code>的生成</p>
<p><img src="/img/2018-01-14/ConfigurationImpl.png" alt="图1"></p>
<p><code>Configuration</code>为配置器原始接口，Hibernate对其的实现是<code>ConfigurationImpl</code><br>，其中<code>ConfigurationState</code>是用于<code>Configuration</code>和<code>ValidationProvider</code>生成<code>ValidatorFactory</code>的契约类，既<code>ConfigurationImpl</code>和<code>HibernateValidator</code>一起生成<code>ValidatorFactoryImpl</code>。</p>
<h5 id="Validator"><a href="#Validator" class="headerlink" title="Validator"></a>Validator</h5><p>回顾使用<code>Validator</code>的使用方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ValidatorFactory validatorFactory = Validation.buildDefaultValidatorFactory();</span><br><span class="line">validatorFactory.getValidator();</span><br></pre></td></tr></table></figure></p>
<p>观察<code>ValidatorFactory</code>接口<br><img src="/img/2018-01-14/ValidatorFactory.png" alt="图2"><br>有如下两个方法：<br><code>ValidatorFactory#getValidator</code>生成可用的验证器<code>ValidatorImpl</code><br><code>ValidatorFactory#usingContext</code>生成可用的上下文<code>ValidatorContextImpl</code></p>
<p>Validator的可用方法如下图所属<br><img src="/img/2018-01-14/Validator.png" alt="图3"></p>
<p>分析方法<code>validate</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;T&gt; Set&lt;ConstraintViolation&lt;T&gt;&gt; validate(T object, Class&lt;?&gt;... groups) &#123;</span><br><span class="line">    ... </span><br><span class="line">    ValidationOrder validationOrder = determineGroupValidationOrder( groups );</span><br><span class="line">    ValidationContext&lt;T&gt; validationContext = getValidationContext().forValidate( object );</span><br><span class="line"></span><br><span class="line">    ValueContext&lt;?, Object&gt; valueContext = ValueContext.getLocalExecutionContext(</span><br><span class="line">            object,</span><br><span class="line">            beanMetaDataManager.getBeanMetaData( object.getClass() ),</span><br><span class="line">            PathImpl.createRootPath()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> validateInContext( valueContext, validationContext, validationOrder );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中：</p>
<ol>
<li><code>ValidationOrder</code> 为校验的顺序，指定当前object的ValidationContext的分组校验顺序，默认为<code>Default.class</code>。</li>
<li><code>ValidationContext</code> 为object的所有带校验信息，以及可用上下文资源，如<code>constraintValidatorManager</code>、<code>messageInterpolator</code>、<code>failFast</code>等，当校验失败时存放失败的校验。</li>
<li><code>ValueContext</code> 为object对象的上下文环境，其内部使用<code>currentValue</code>指向正在进行校验的参数</li>
</ol>
<p>通过结合如下调用栈查看验证过程：</p>
<p>–&gt;<br><code>MetaConstraint#validateConstraint</code></p>
<p>–&gt;<br><code>ConstraintTree#validateConstraints(ValidationContext&lt;T&gt;,ValueContext&lt;?,?&gt;)</code></p>
<p>–&gt;<br><code>ConstraintTree#validateSingleConstraint</code>方法内调用<code>ConstraintValidator</code>进行参数校验。</p>
<p>最终通过<code>validationContext.getFailingConstraints()</code>返回该对象的校验结果<code>Set&lt;ConstraintViolation&lt;T&gt;&gt;</code></p>
<p>参考更多：</p>
<ol>
<li><a href="https://baike.baidu.com/item/Java%20Community%20Process/19279280?fr=aladdin" target="_blank" rel="noopener">百度百科 – JCP组织</a></li>
<li><a href="https://jcp.org/en/jsr/detail?id=303" target="_blank" rel="noopener">JSR-303规范</a></li>
<li><a href="https://jcp.org/en/jsr/detail?id=349" target="_blank" rel="noopener">JSR-349规范</a></li>
<li><a href="https://www.jcp.org/en/jsr/detail?id=380" target="_blank" rel="noopener">JSR-380规范</a></li>
<li><a href="https://my.oschina.net/zzuqiang/blog/761862" target="_blank" rel="noopener">JSR303、349 -Bean Validation 数据校验规范使用说明和验证流程源码分析</a></li>
<li><a href="http://www.voidcn.com/article/p-slnpupti-bqy.html" target="_blank" rel="noopener">常用注解的介绍</a></li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2017/02/22/2017-2-22-Spring（一）/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2018 <a href="http://lshao.xyz">潜水的沙</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>